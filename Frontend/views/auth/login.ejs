<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión</title>
    <script> const nombreCompleto = sessionStorage.getItem('profesorNombre');
        if (nombreCompleto) {
            window.location.href = '/principal';
        }</script>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Incluir CSS personalizado -->
    <link href="css/styles.css" rel="stylesheet">
    <!-- Font Awesome para el ícono de ojito -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head>

<body class="body-login">
    <div class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="col-md-6 col-lg-5"> <!-- Ajustamos el tamaño aquí -->
            <div class="card shadow-lg p-4" style="border-radius: 15px; background-color: rgba(255, 255, 255, 0.6);">
                <div class="card-body">
                    <h2 class="text-center mb-4">Iniciar Sesión</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="correo">Correo Electrónico</label>
                            <input type="email" class="form-control" id="correo" name="correo" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required>
                                <div class="input-group-append">
                                    <span class="input-group-text" onclick="togglePassword(this)"
                                        style="cursor: pointer;">
                                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div id="loginError" class="text-danger text-center"></div>
                        <button type="submit" class="btn btn-primary btn-block">Iniciar Sesión</button>
                        <div class="text-right mt-2">
                            <a href="#" id="btn-registrarme">Registrarme</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Registro de Maestro</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="nombreCompleto">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaNacimiento">Fecha de Nacimiento</label>
                            <input type="text" class="form-control" id="fechaNacimiento" name="fechaNacimiento"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="identificacion">Identificación</label>
                            <input type="text" class="form-control" id="identificacion" name="identificacion" required>
                        </div>
                        <div class="form-group">
                            <label for="correoRegistro">Correo Electrónico</label>
                            <input type="email" class="form-control" id="correoRegistro" name="correo" required>
                        </div>
                        <div class="form-group">
                            <label for="telefono">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" required>
                        </div>
                        <div class="form-group">
                            <label for="passwordRegistro">Contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="passwordRegistro" name="password"
                                    required>
                                <div class="input-group-append">
                                    <span class="input-group-text" onclick="togglePassword(this)"
                                        style="cursor: pointer;">
                                        <i class="fas fa-eye" id="togglePasswordIconRegistro"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div id="registerError" class="text-danger text-center mt-2"></div>
                        <button type="submit" class="btn btn-primary btn-block">Registrarme</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Script para mostrar/ocultar contraseña -->
    <script>

        function togglePassword(element) {
            // Buscar el contenedor principal del input y el icono
            const inputGroup = element.closest('.input-group');

            // Buscar el campo de contraseña dentro del mismo contenedor
            const passwordField = inputGroup.querySelector('input[type="password"], input[type="text"]');
            const toggleIcon = element.querySelector('i');

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }


        document.addEventListener('DOMContentLoaded', function () {
            const registerModal = document.getElementById('registerModal');

            flatpickr("#fechaNacimiento", {
                dateFormat: "Y-m-d", // Formato de fecha
                minDate: "1900-01-01", // Fecha mínima
                maxDate: new Date().toISOString().split("T")[0] // Fecha máxima (hoy)
            });

            $('#registerModal').on('hidden.bs.modal', function () {
        // Seleccionar el formulario dentro del modal
        const registerForm = document.getElementById('registerForm');
        // Restablecer el formulario
        registerForm.reset();
        // Limpiar mensajes de error si existen
        document.getElementById('registerError').textContent = '';
    });


            // Abrir el modal de registro al hacer clic en "Registrarme"
            document.getElementById('btn-registrarme').addEventListener('click', function (event) {
                event.preventDefault(); // Evitar que el enlace recargue la página
                $('#registerModal').modal('show'); // Mostrar el modal
            });

            // Manejo del formulario de login
            document.getElementById('loginForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const correo = document.getElementById('correo').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('loginError');

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ correo, password })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Si el login es exitoso, guardar datos de sesión y redirigir
                        sessionStorage.setItem('profesorAvatar', result.profesor.avatar);
                        sessionStorage.setItem('profesorId', result.profesor._id); // Puedes ajustar la clave
                        sessionStorage.setItem('profesorNombre', result.profesor.nombreCompleto); // Guardar el nombre del usuario
                        window.location.href = '/principal'; // Redirigir a una ruta protegida
                    } else {
                        loginError.textContent = result.message || 'Error al iniciar sesión';
                    }
                } catch (error) {
                    loginError.textContent = 'Ocurrió un error inesperado';
                }
            });

            // Manejar el formulario de registro
            document.getElementById('registerForm').addEventListener('submit', async function (event) {
                event.preventDefault(); // Evitar el envío del formulario por defecto

                // Obtener los valores de los campos del formulario
                const nombreCompleto = document.getElementById('nombreCompleto').value;
                const fechaNacimiento = document.getElementById('fechaNacimiento').value;
                const identificacion = document.getElementById('identificacion').value;
                const correo = document.getElementById('correoRegistro').value;
                const telefono = document.getElementById('telefono').value;
                const password = document.getElementById('passwordRegistro').value;

                try {
                    // Enviar los datos a la API
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            nombreCompleto,
                            fechaNacimiento,
                            identificacion,
                            correo,
                            telefono,
                            password
                        })
                    });

                    const data = await response.json();

                    // Manejar la respuesta de la API
                    if (response.ok) {
                        // Registro exitoso
                        alert('Registro completado exitosamente. Por favor, inicia sesión.');
                        $('#registerModal').modal('hide'); // Cerrar el modal
                    } else {
                        // Mostrar el mensaje de error de la API
                        if (data.message === "Correo o Identificación ya existen") {
                            document.getElementById('registerError').textContent = "Correo o Identificación ya existen.";
                        } else {
                            document.getElementById('registerError').textContent = "Error en el registro. Inténtalo nuevamente.";
                        }
                    }
                } catch (error) {
                    // Manejar errores de red u otros errores no previstos
                    document.getElementById('registerError').textContent = "Error en el registro. Verifica tu conexión.";
                }
            });
        });

    </script>
</body>

</html>